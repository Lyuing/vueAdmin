# 用户认证与路由流程图

本文档详细说明了系统中用户登录、认证、路由守卫、动态路由加载等核心流程的逻辑走向。

## 1. 应用初始化流程

```mermaid
flowchart TD
    A[应用启动] --> B[创建Vue应用实例]
    B --> C[注册Pinia状态管理]
    C --> D[注册Router路由]
    D --> E[注册i18n国际化]
    E --> F[注册Element Plus]
    F --> G[初始化应用 initApp]
    
    G --> H[恢复认证状态 authStore.restoreAuth]
    H --> I{从localStorage读取token和userInfo}
    I -->|存在| J[恢复到authStore]
    I -->|不存在| K[保持未登录状态]
    
    J --> L[设置路由守卫 setupRouterGuards]
    K --> L
    
    L --> M{用户已登录?}
    M -->|是| N[加载动态路由 addDynamicRoutes]
    M -->|否| O[跳过动态路由加载]
    
    N --> P[初始化主题]
    O --> P
    P --> Q[等待路由准备]
    Q --> R[挂载应用到DOM]
```

## 2. 用户登录流程

```mermaid
flowchart TD
    A[用户访问登录页 /login] --> B{已登录?}
    B -->|是| C[重定向到 /home]
    B -->|否| D[显示登录表单]
    
    D --> E[用户输入用户名和密码]
    E --> F[点击登录按钮]
    F --> G[调用 authStore.login]
    
    G --> H[调用 loginApi]
    H --> I[Mock验证或真实API调用]
    
    I --> J{验证成功?}
    J -->|否| K[显示错误提示]
    K --> D
    
    J -->|是| L[返回token和userInfo]
    L --> M[保存到authStore]
    M --> N[保存到localStorage]
    
    N --> O[加载动态路由 addDynamicRoutes]
    O --> P[根据权限过滤路由]
    P --> Q[添加路由到router]
    Q --> R[生成菜单数据]
    
    R --> S[跳转到首页 /home]
```

## 3. 路由守卫流程

```mermaid
flowchart TD
    A[用户访问路由] --> B{目标路由是 /login?}
    B -->|是| C{已登录?}
    C -->|是| D[重定向到 /home]
    C -->|否| E[允许访问登录页]
    
    B -->|否| F{路由是否存在?}
    F -->|不存在| G{已登录?}
    G -->|否| H[跳转到 /login]
    G -->|是| I[尝试加载动态路由]
    I --> J{加载成功?}
    J -->|是| K[重新导航到目标路由]
    J -->|否| L[跳转到 /404]
    
    F -->|存在| M{路由需要认证?}
    M -->|否| N[允许访问]
    
    M -->|是| O{已登录?}
    O -->|否| P[提示请先登录]
    P --> Q[跳转到 /login]
    
    O -->|是| R{路由有权限要求?}
    R -->|否| S[自动展开菜单]
    S --> T[允许访问]
    
    R -->|是| U[检查用户权限]
    U --> V{有权限?}
    V -->|否| W[提示无权限]
    W --> X[跳转到 /403]
    V -->|是| S
```

## 4. 动态路由加载流程

```mermaid
flowchart TD
    A[调用 addDynamicRoutes] --> B{已加载且非强制刷新?}
    B -->|是| C[直接返回]
    
    B -->|否| D[根据用户权限过滤路由]
    D --> E[遍历routeMap]
    E --> F{路由有权限要求?}
    
    F -->|否| G[保留路由]
    F -->|是| H{用户有对应权限?}
    H -->|是| G
    H -->|否| I[过滤掉该路由]
    
    G --> J[递归处理子路由]
    I --> J
    
    J --> K[将过滤后的路由添加到router]
    K --> L[添加404通配路由]
    L --> M[标记动态路由已加载]
    
    M --> N[生成菜单数据]
    N --> O{第一个路由是Layout?}
    O -->|是| P[展开Layout的children作为菜单]
    O -->|否| Q[直接使用路由作为菜单]
    
    P --> R[保存到menuStore]
    Q --> R
```

## 5. HTTP请求拦截流程

```mermaid
flowchart TD
    A[发起HTTP请求] --> B[请求拦截器]
    B --> C{localStorage有token?}
    C -->|是| D[添加Authorization头]
    C -->|否| E[不添加token]
    
    D --> F[发送请求]
    E --> F
    
    F --> G[响应拦截器]
    G --> H{响应成功?}
    
    H -->|是| I{业务状态码正常?}
    I -->|是| J[返回数据]
    I -->|否| K[显示错误消息]
    K --> L[Promise.reject]
    
    H -->|否| M{HTTP状态码}
    M -->|401| N[提示登录过期]
    N --> O[清除token和userInfo]
    O --> P[跳转到 /login]
    
    M -->|403| Q[提示无权限]
    M -->|404| R[提示资源不存在]
    M -->|500| S[提示服务器错误]
    M -->|其他| T[显示通用错误]
    
    Q --> L
    R --> L
    S --> L
    T --> L
```

## 6. 用户登出流程

```mermaid
flowchart TD
    A[用户点击登出] --> B[调用 authStore.logout]
    B --> C[调用 logoutApi]
    
    C --> D{API调用成功?}
    D -->|失败| E[记录错误日志]
    D -->|成功| F[继续登出流程]
    E --> F
    
    F --> G[清空authStore中的token]
    G --> H[清空authStore中的userInfo]
    H --> I[从localStorage移除token]
    I --> J[从localStorage移除userInfo]
    
    J --> K[重定向到 /login]
    K --> L[路由守卫清除动态路由]
```

## 7. Token刷新流程（预留）

```mermaid
flowchart TD
    A[HTTP响应401] --> B{是否有refreshToken?}
    B -->|否| C[跳转到登录页]
    
    B -->|是| D[调用 refreshToken API]
    D --> E{刷新成功?}
    
    E -->|否| F[清除认证信息]
    F --> C
    
    E -->|是| G[更新token]
    G --> H[保存到localStorage]
    H --> I[重试原请求]
    I --> J[返回结果]
```

## 8. 权限检查流程

```mermaid
flowchart TD
    A[检查权限 checkPermission] --> B[获取路由所需权限列表]
    B --> C[获取用户权限列表]
    
    C --> D{路由权限列表为空?}
    D -->|是| E[允许访问]
    
    D -->|否| F[遍历路由所需权限]
    F --> G{用户权限包含该权限?}
    
    G -->|是| H{还有其他权限需要检查?}
    H -->|是| F
    H -->|否| E
    
    G -->|否| I[拒绝访问]
```

## 9. 页面刷新恢复状态流程

```mermaid
flowchart TD
    A[用户刷新页面 F5] --> B[应用重新初始化]
    B --> C[执行 authStore.restoreAuth]
    
    C --> D{localStorage有token?}
    D -->|否| E[保持未登录状态]
    E --> F[路由守卫拦截]
    F --> G[跳转到 /login]
    
    D -->|是| H[恢复token到authStore]
    H --> I{localStorage有userInfo?}
    I -->|否| E
    
    I -->|是| J[恢复userInfo到authStore]
    J --> K[重新加载动态路由]
    K --> L[根据权限过滤路由]
    L --> M[添加路由到router]
    M --> N[生成菜单]
    
    N --> O[路由守卫检查]
    O --> P{当前路由需要权限?}
    P -->|否| Q[正常访问]
    P -->|是| R{用户有权限?}
    R -->|是| Q
    R -->|否| S[跳转到 /403]
```

## 核心要点总结

### 认证状态持久化
- 使用 `localStorage` 存储 `token` 和 `userInfo`
- 应用初始化时通过 `restoreAuth()` 恢复状态
- 页面刷新后自动恢复登录状态

### 动态路由机制
- 登录成功后根据用户权限动态加载路由
- 使用 `router.addRoute()` 动态添加路由
- 路由守卫中处理404情况，尝试加载动态路由

### 权限控制
- 路由级别：通过 `meta.permissions` 定义所需权限
- 路由守卫：在访问前检查用户是否有对应权限
- 菜单生成：只显示用户有权限访问的菜单项

### HTTP拦截
- 请求拦截：自动添加 `Authorization` 头
- 响应拦截：统一处理401（未登录）、403（无权限）等错误
- 401错误自动清除认证信息并跳转登录页

### 安全机制
- Token过期自动跳转登录页
- 未登录用户访问受保护路由自动重定向
- 无权限访问跳转403页面
- 登出时彻底清除本地认证信息
